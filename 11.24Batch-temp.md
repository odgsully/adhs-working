# BD_ Prefix Column Name Migration Plan
**Date**: 2024-11-24
**Status**: ✅ COMPLETE - ALL TIERS DONE
**Template Updated**: Yes (`Batchdata_Template.xlsx` already has new column names)

---

## Current Implementation Status

| Tier | Description | Status | Files |
|------|-------------|--------|-------|
| **TIER 1** | Python Source Files | ✅ **COMPLETE** | 6/6 |
| **TIER 2** | Test Files | ✅ **COMPLETE** | 11/11 |
| **TIER 2.5** | Excel Test/Config Files | ✅ **COMPLETE** | 2/2 |
| **TIER 3** | Utility Scripts | ✅ **COMPLETE** | 11/11 |
| **TIER 4** | Documentation Files | ✅ **COMPLETE** | 8/8 |

---

## TIER 1: Python Source Files - ✅ COMPLETE

| File | Status | Changes Made |
|------|--------|--------------|
| `Batchdata/src/batchdata_sync.py` | ✅ Complete | All column refs updated (record_id→BD_RECORD_ID, phone_N→BD_PHONE_N, etc.) |
| `Batchdata/src/transform.py` | ✅ Complete | Record dictionaries, deduplication, validation fields updated |
| `Batchdata/src/normalize.py` | ✅ Complete | Default param `owner_name_full` → `BD_OWNER_NAME_FULL` |
| `Batchdata/src/io.py` | ✅ Complete | Expected fields reference updated |
| `Batchdata/src/run.py` | ✅ Complete | Merge keys `record_id` → `BD_RECORD_ID` |
| `src/adhs_etl/batchdata_bridge.py` | ✅ Complete | No changes needed (no column refs) |

**Verification**: All imports successful ✅
```bash
poetry run python -c "from Batchdata.src.batchdata_sync import *; from Batchdata.src.transform import *"
# ✅ All source files import successfully
```

---

## TIER 2: Test Files - ✅ COMPLETE

| File | Status | Changes Made |
|------|--------|--------------|
| `tests/test_sync_client.py` | ✅ Complete | Sample DataFrame cols, phone/email assertions updated |
| `tests/test_api_response_handling.py` | ✅ Complete | Phone test data, merge field references updated |
| `tests/test_integration.py` | ✅ Complete | No BD_ column refs (uses eCorp cols - correct) |
| `tests/test_sync_integration.py` | ✅ Complete | Mock response, batching, enrichment cols updated |
| `tests/test_template_output.py` | ✅ Complete | Mock result DataFrame columns updated |
| `tests/test_deduplication.py` | ✅ Complete | Test DataFrame columns updated |
| `tests/test_entity_families.py` | ✅ Complete | Test DataFrame columns updated |
| `tests/test_field_completeness.py` | ✅ Complete | Validation, optimization, transformation refs updated |
| `tests/test_ecorp_alignment.py` | ✅ Complete | Column assertions updated |
| `tests/test_address_fixes.py` | ✅ Complete | Address/name column refs updated |
| `tests/test_pipeline.py` | ✅ Complete | All column references updated |

---

## TIER 2.5: Excel Test/Config Files - ✅ COMPLETE

| File | Status | Changes Made |
|------|--------|--------------|
| `Batchdata/tests/batchdata_local_input.xlsx` | ✅ Complete | INPUT_MASTER: 20 columns renamed |
| `Batchdata/template_config.xlsx` | ✅ Complete | INPUT_MASTER: 20 columns renamed |

---

## TIER 3: Utility Scripts - ✅ COMPLETE

| File | Status | Changes Made |
|------|--------|--------------|
| `Batchdata/utils/create_test_input.py` | ✅ Complete | Sample output columns updated |
| `Batchdata/utils/demo.py` | ✅ Complete | Display column references updated |
| `Batchdata/utils/analyze_duplicates.py` | ✅ Complete | Groupby and analysis columns updated |
| `Batchdata/utils/analyze_empty_names.py` | ✅ Complete | Name/address field references updated |
| `Batchdata/debug_api_errors.py` | ✅ Complete | Output, critical fields updated |
| `Batchdata/debug_complete_file.py` | ✅ Complete | Phone/email, sample columns updated |
| `Batchdata/check_upload_file.py` | ✅ Complete | Field analysis, sample records updated |
| `Batchdata/diagnose_state_issue.py` | ✅ Complete | Address field keys updated |
| `Batchdata/fix_state_transform.py` | ✅ Complete | (Documentation only - no changes needed) |
| `Batchdata/test_v1_skiptrace.py` | ✅ Complete | CSV header columns updated |
| `Batchdata/test_v2_async_with_state_fix.py` | ✅ Complete | State validation, display columns updated |

---

## TIER 4: Documentation Files - ✅ COMPLETE

| File | Status | Changes Made |
|------|--------|--------------|
| `Batchdata/README.md` | ✅ Complete | INPUT_MASTER columns updated |
| `Batchdata/PIPELINE_INTEGRATION_GUIDE.md` | ✅ Complete | Input/output specs, test data updated |
| `Batchdata/BD_PREFIX_MIGRATION.md` | ✅ N/A | Reference doc - mapping table unchanged |
| `Batchdata/PHASE_1_TEST_RESULTS.md` | ✅ Complete | Schema references updated |
| `Batchdata/V2_QUICK_START.md` | ✅ Complete | Code examples updated |
| `Batchdata/SYNC_MIGRATION_IMPLEMENTATION.md` | ✅ Complete | Schema, checklists, pitfalls updated |
| `Batchdata/docs/examples/PRD_BatchData_Bulk_Pipeline.md` | ✅ Complete | Input contract, objectives updated |
| `Batchdata/docs/examples/claude_code_prompt.md` | ✅ Complete | Join key references updated |

**Note**: Historical diagnostic files (DIAGNOSTIC_REPORT_API_ISSUES.md, IMMEDIATE_FIX.md) retain old column names as they document past issues.

---

## Complete Column Mapping (103 columns)

### Core Input Columns (20)

| Old | New |
|-----|-----|
| `record_id` | `BD_RECORD_ID` |
| `source_type` | `BD_SOURCE_TYPE` |
| `source_entity_name` | `BD_ENTITY_NAME` |
| `source_entity_id` | `BD_SOURCE_ENTITY_ID` |
| `title_role` | `BD_TITLE_ROLE` |
| `target_first_name` | `BD_TARGET_FIRST_NAME` |
| `target_last_name` | `BD_TARGET_LAST_NAME` |
| `owner_name_full` | `BD_OWNER_NAME_FULL` |
| `address_line1` | `BD_ADDRESS` |
| `address_line2` | `BD_ADDRESS_2` |
| `city` | `BD_CITY` |
| `state` | `BD_STATE` |
| `zip` | `BD_ZIP` |
| `county` | `BD_COUNTY` |
| `apn` | `BD_APN` |
| `mailing_line1` | `BD_MAILING_LINE1` |
| `mailing_city` | `BD_MAILING_CITY` |
| `mailing_state` | `BD_MAILING_STATE` |
| `mailing_zip` | `BD_MAILING_ZIP` |
| `notes` | `BD_NOTES` |

### Phone Columns (60) - Pattern for N=1-10

| Old Pattern | New Pattern |
|-------------|-------------|
| `phone_N` | `BD_PHONE_N` |
| `phone_N_type` | `BD_PHONE_N_TYPE` |
| `phone_N_carrier` | `BD_PHONE_N_CARRIER` |
| `phone_N_dnc` | `BD_PHONE_N_DNC` |
| `phone_N_tcpa` | `BD_PHONE_N_TCPA` |
| `phone_N_confidence` | `BD_PHONE_N_CONFIDENCE` |

### Email Columns (20) - Pattern for N=1-10

| Old Pattern | New Pattern |
|-------------|-------------|
| `email_N` | `BD_EMAIL_N` |
| `email_N_tested` | `BD_EMAIL_N_TESTED` |

### API/Pipeline Status Columns (9)

| Old | New |
|-----|-----|
| `api_status` | `BD_API_STATUS` |
| `api_response_time` | `BD_API_RESPONSE_TIME` |
| `persons_found` | `BD_PERSONS_FOUND` |
| `phones_found` | `BD_PHONES_FOUND` |
| `emails_found` | `BD_EMAILS_FOUND` |
| `pipeline_version` | `BD_PIPELINE_VERSION` |
| `pipeline_timestamp` | `BD_PIPELINE_TIMESTAMP` |
| `stages_applied` | `BD_STAGES_APPLIED` |

---

## Critical Distinctions

### What TO Change (BatchData columns)
- Column names in INPUT_MASTER sheet headers
- Column names in OUTPUT_MASTER sheet headers
- Python string literals that CREATE these columns
- Python string literals that READ these columns from DataFrames
- Test fixture DataFrames with these columns
- Documentation referencing these columns

### What NOT to Change
- **eCorp input columns**: `ECORP_NAME_S`, `ECORP_ENTITY_ID_S`, etc. (upstream data)
- **MCAO input columns**: `MCAO_*` columns (upstream data)
- **APN input columns**: `APN_*` columns (upstream data)
- **BatchData API response fields**: `number`, `type`, `carrier`, `first`, `last`, etc. (API returns these names)
- **Sheet names**: CONFIG, INPUT_MASTER, BLACKLIST_NAMES, OUTPUT_MASTER
- **Python variable names**: Only change string literals in quotes

### API Response Mapping Pattern
```python
# The API returns fields like 'number', 'type' - DON'T change these
api_response['phones'][0]['number']  # DON'T change 'number'

# But the OUTPUT column name DOES change
result['BD_PHONE_1'] = api_response['phones'][0]['number']  # DO change 'BD_PHONE_1'
```

---

## Verification Commands

### Source File Verification (COMPLETE)
```bash
# All passed ✅
poetry run python -c "from Batchdata.src.batchdata_sync import *"
poetry run python -c "from Batchdata.src.transform import *"
poetry run python -c "from Batchdata.src.run import *"

# No old column names found ✅
grep -rn "'record_id'\|'phone_1'\|'email_1'\|'api_status'" Batchdata/src/ --include="*.py"
# (returns empty - all updated)
```

### Test Verification (PENDING)
```bash
cd Batchdata && python -m pytest tests/ -v
```

### Excel File Verification (PENDING)
```bash
python3 -c "
import pandas as pd
xl = pd.ExcelFile('Batchdata/tests/batchdata_local_input.xlsx')
df = pd.read_excel(xl, sheet_name='INPUT_MASTER', nrows=1)
non_bd = [c for c in df.columns if not c.startswith('BD_')]
if non_bd:
    print(f'ERROR: Non-BD columns found: {non_bd}')
else:
    print('OK: All INPUT_MASTER columns have BD_ prefix')
"
```

---

## Risk Mitigation

### Backward Compatibility
- **Breaking Change**: Existing BatchData Upload/Complete files with old column names will NOT be compatible
- **Mitigation**: This is acceptable since we're updating the entire pipeline simultaneously
- **Note**: Any manual Excel files users created will need column headers updated

### Rollback Strategy
- All changes are in tracked files
- Git revert if needed: `git revert HEAD` after commit

---

## Files Confirmed NOT Needing Changes

| File | Reason |
|------|--------|
| `Batchdata/src/batchdata.py` | No column name references (HTTP client only) |
| `Batchdata/src/__init__.py` | No column name references |
| `src/adhs_etl/batchdata_bridge.py` | No column name references |
| Sheet names in code | CONFIG, INPUT_MASTER, etc. stay the same |

---

## Next Steps

1. **TIER 2**: Update 11 test files with new column names
2. **TIER 2.5**: Update 2 Excel test/config files
3. **TIER 3**: Update 11 utility scripts
4. **TIER 4**: Update 10+ documentation files
5. **Final Validation**: Run full test suite

---

## Notes

- Upload files (columns A-P, Q:CO blank) will have headers but empty enrichment columns
- Complete files will have all columns populated after API processing
- No functional changes to how data is populated - only header names change
